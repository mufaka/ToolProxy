<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:ToolProxy.Chat.ViewModels"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
		xmlns:md="clr-namespace:Markdown.Avalonia;assembly=Markdown.Avalonia"
		xmlns:avedit="https://github.com/avaloniaui/avaloniaedit"
		xmlns:ctxt="clr-namespace:ColorTextBlock.Avalonia;assembly=ColorTextBlock.Avalonia"
        mc:Ignorable="d" d:DesignWidth="1000" d:DesignHeight="700"
        x:Class="ToolProxy.Chat.Views.MainWindow"
        x:DataType="vm:MainWindowViewModel"
        Title="ToolProxy Chat" Width="1000" Height="700"
        MinWidth="800" MinHeight="600">

	<Design.DataContext>
		<vm:MainWindowViewModel/>
	</Design.DataContext>

	<SplitView IsPaneOpen="{Binding IsDrawerOpen}"
			   DisplayMode="Overlay"
			   OpenPaneLength="450"
			   PanePlacement="Right">

		<!-- Drawer Pane Content -->
		<SplitView.Pane>
			<Border Background="#2E3440" Padding="15">
				<ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
					<StackPanel>
						<Button Command="{Binding ToggleDrawerCommand}" Content="Close" />
						<TextBlock Text="Tools &amp; Settings"
								   FontSize="18" FontWeight="Bold"
								   Foreground="White" Margin="0,0,0,20"/>

						<!-- Tool Proxy MCP Server Tools -->
						<Expander Header="Tool Proxy MCP Server" IsExpanded="True" Margin="0,0,0,15">
							<StackPanel Margin="10,10,0,0">
								<!-- Summary Information -->
								<StackPanel Orientation="Horizontal" Margin="0,0,0,10"
											IsVisible="{Binding !IsLoadingTools}">
									<TextBlock Text="ðŸ“Š" Foreground="#81A1C1" Margin="0,0,5,0"/>
									<TextBlock Text="{Binding AvailableServers.Count, StringFormat='{}{0} servers'}"
											   Foreground="#D8DEE9" FontSize="11" Margin="0,0,8,0"/>
									<TextBlock Text="â€¢" Foreground="#4C566A" FontSize="11" Margin="0,0,8,0"/>
									<TextBlock Text="{Binding AvailableToolsCount, StringFormat='{}{0} tools'}"
											   Foreground="#D8DEE9" FontSize="11" Margin="0,0,8,0"/>
								</StackPanel>

								<!-- Refresh Button -->
								<Button Content="Refresh Tools"
										Command="{Binding RefreshToolsCommand}"
										IsEnabled="{Binding !IsLoadingTools}"
										Background="#5E81AC" Foreground="White"
										HorizontalAlignment="Left" Padding="10,5" Margin="0,0,0,10"/>

								<!-- Loading Indicator -->
								<TextBlock Text="Loading tools..."
										   Foreground="Yellow" FontStyle="Italic"
										   IsVisible="{Binding IsLoadingTools}"
										   Margin="0,0,0,10"/>

								<!-- Servers and Tools List -->
								<ItemsControl ItemsSource="{Binding AvailableServers}" IsVisible="{Binding !IsLoadingTools}">
									<ItemsControl.ItemTemplate>
										<DataTemplate>
											<Expander Header="{Binding Name}" IsExpanded="False" Margin="0,0,0,5">
												<StackPanel Margin="10,5,0,0">
													<TextBlock Text="{Binding Description}"
															   Foreground="#D8DEE9" FontSize="12"
															   Margin="0,0,0,10" FontStyle="Italic"/>

													<!-- Tools List -->
													<ItemsControl ItemsSource="{Binding Tools}">
														<ItemsControl.ItemTemplate>
															<DataTemplate>
																<Border Background="#3B4252"
																		CornerRadius="4"
																		Padding="10,8"
																		Margin="0,3">
																	<StackPanel>
																		<!-- Tool Name and Description -->
																		<StackPanel Orientation="Horizontal" Margin="0,0,0,4">
																			<TextBlock Text="ðŸ”§" Foreground="#81A1C1" Margin="0,0,6,0" FontSize="12"/>
																			<TextBlock Text="{Binding Name}"
																					   Foreground="White"
																					   FontWeight="SemiBold"
																					   FontSize="12"/>
																		</StackPanel>

																		<TextBlock Text="{Binding Description}"
																				   Foreground="#D8DEE9"
																				   FontSize="10"
																				   TextWrapping="Wrap"
																				   Margin="0,0,0,6"/>

																		<!-- Parameters Count (if any) -->
																		<StackPanel Orientation="Horizontal"
																					Margin="0,0,0,0"
																					IsVisible="{Binding Parameters, Converter={x:Static vm:MainWindowViewModel.HasParametersConverter}}">
																			<TextBlock Text="ðŸ“‹" Foreground="#A3BE8C" Margin="0,0,4,0" FontSize="9"/>
																			<TextBlock Text="{Binding Parameters.Count, StringFormat='{}{0} parameters'}"
																					   Foreground="#A3BE8C"
																					   FontSize="9"
																					   FontStyle="Italic"/>
																		</StackPanel>
																	</StackPanel>
																</Border>
															</DataTemplate>
														</ItemsControl.ItemTemplate>
													</ItemsControl>

													<!-- No tools message -->
													<TextBlock Text="No tools available"
															   Foreground="#BF616A"
															   FontStyle="Italic"
															   FontSize="11"
															   Margin="0,10,0,0"
															   IsVisible="{Binding Tools.Count, Converter={x:Static vm:MainWindowViewModel.ZeroCountToBoolConverter}}"/>
												</StackPanel>
											</Expander>
										</DataTemplate>
									</ItemsControl.ItemTemplate>
								</ItemsControl>
								<!-- No servers message -->
								<TextBlock Text="No servers connected"
										   Foreground="#BF616A"
										   FontStyle="Italic"
										   Margin="0,10,0,0"
										   IsVisible="{Binding AvailableServers.Count, Converter={x:Static vm:MainWindowViewModel.ZeroCountToBoolConverter}}"/>
							</StackPanel>
						</Expander>

					</StackPanel>
				</ScrollViewer>
			</Border>
		</SplitView.Pane>

		<!-- SplitView Content Area -->
		<SplitView.Content>
			<DockPanel>
				<!-- Main Content Area -->
				<Grid RowDefinitions="Auto,*,Auto,Auto">

					<!-- Toolbar -->
					<Border Grid.Row="0" Padding="15,10">
						<Grid ColumnDefinitions="*,Auto,Auto">
							<TextBlock Grid.Column="0" Text="ToolProxy Chat Assistant"
									   VerticalAlignment="Center" Foreground="White" FontWeight="Bold" FontSize="16"/>
							<Button Grid.Column="1" Content="Clear History"
									Command="{Binding ClearHistoryCommand}"
									Background="Transparent" Foreground="White" BorderBrush="White"
									Margin="0,0,10,0"/>
							<Button Grid.Column="2" Content="â˜°" FontSize="16"
										  Command="{Binding ToggleDrawerCommand}"
										  Background="Transparent" Foreground="White" BorderBrush="White"
										  Padding="10,5" ToolTip.Tip="Toggle Tools Panel"/>
						</Grid>
					</Border>

					<!-- Chat Messages -->
					<ScrollViewer Grid.Row="1" Name="ChatScrollViewer" VerticalScrollBarVisibility="Auto" Foreground="#666">
						<ItemsControl ItemsSource="{Binding Messages}" Margin="10">
							<ItemsControl.ItemTemplate>
								<DataTemplate>
									<Border Margin="5" Padding="15" CornerRadius="10" MaxWidth="800"
											Background="{Binding Role, Converter={x:Static vm:MainWindowViewModel.MessageBackgroundConverter}}"
											HorizontalAlignment="{Binding Role, Converter={x:Static vm:MainWindowViewModel.MessageAlignmentConverter}}">
										<StackPanel>
											<TextBlock Text="{Binding Role}" FontWeight="Bold" FontSize="12"
													  Foreground="#666" Margin="0,0,0,5"/>
											<md:MarkdownScrollViewer Markdown="{Binding Content}">
												<md:MarkdownScrollViewer.MarkdownStyle>
													<Style>
														<Style Selector=".Markdown_Avalonia_MarkdownViewer TextBlock.CodeBlock">
															<Style.Setters>
																<Setter Property="Foreground" Value="#333" />
															</Style.Setters>
														</Style>
														<Style Selector=".Markdown_Avalonia_MarkdownViewer ctxt|CCode">
															<Style.Setters>
																<Setter Property="Foreground" Value="#333" />
															</Style.Setters>
														</Style>
													</Style>
												</md:MarkdownScrollViewer.MarkdownStyle>
											</md:MarkdownScrollViewer>
											<TextBlock Text="{Binding Timestamp, StringFormat='{}{0:HH:mm:ss}'}"
													  Foreground="#666" FontSize="10" Opacity="0.6" HorizontalAlignment="Right" Margin="0,5,0,0"/>
										</StackPanel>
									</Border>
								</DataTemplate>
							</ItemsControl.ItemTemplate>
						</ItemsControl>
					</ScrollViewer>

					<!-- Input Area -->
					<Border Grid.Row="2"
							BorderThickness="0,1,0,0" Padding="15">
						<Grid ColumnDefinitions="*,Auto">
							<TextBox Grid.Column="0" x:Name="MessageInput"
									 Text="{Binding CurrentMessage}"
									 Watermark="Type your message here... (Enter to send, Shift+Enter for new line)"
									 AcceptsReturn="True" MaxHeight="100"
									 VerticalAlignment="Center">
							</TextBox>
							<Button Grid.Column="1" Content="Send" Margin="10,0,0,0"
									Command="{Binding SendMessageCommand}"
									IsEnabled="{Binding !IsProcessing}"/>
						</Grid>
					</Border>

					<!-- Status Bar -->
					<Border Grid.Row="3" Background="#343A40" Padding="15,8">
						<Grid ColumnDefinitions="*,Auto">
							<TextBlock Grid.Column="0" Text="{Binding StatusMessage}"
									   VerticalAlignment="Center" Foreground="White"/>
							<StackPanel Grid.Column="1" Orientation="Horizontal">
								<TextBlock Text="Status: " VerticalAlignment="Center" Foreground="White"/>
								<Ellipse Width="8" Height="8"
										 Fill="{Binding IsConnected, Converter={x:Static vm:MainWindowViewModel.BooleanToBrushConverter}}"/>
							</StackPanel>
						</Grid>
					</Border>
				</Grid>
			</DockPanel>
		</SplitView.Content>
	</SplitView>
</Window>